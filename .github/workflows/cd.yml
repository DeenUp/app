name: Continuous Deployment

on:
    pull_request:
        types: [closed]
        branches:
            - production
            - dev
    push:
        branches:
            - staging

jobs:
    build-ios:
        runs-on: macOS-latest
        environment: ${{ github.ref_name}}

        steps:
            - name: 📂 Checkout code
              uses: actions/checkout@v4

            - name: 🚀 Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: latest

            - name: Install pnpm
              run: npm install -g pnpm --unsafe-perm=true

            - name: 📦 Install dependencies
              run: pnpm install

            - name: Generate .env.${{ github.ref_name }} file adding FLAVOR and EXPO_PROJECT_ID
              run: |
                  touch .env
                  echo "FLAVOR=${{ github.ref_name }}" > .env
                  echo "EXPO_PROJECT_ID=${{ secrets.EXPO_PROJECT_ID }}" >> .env

            - name: 📜 Create Amplify config
              run: |
                  echo ${{secrets.AMPLIFY_CONFIG}} | base64 --decode > src/configs/amplify/amplify-${{github.ref_name}}.json

            - name: 🔍 Check if Amplify config exists
              run: |
                  if [ ! -f src/configs/amplify/amplify-${{github.ref_name}}.json ]; then
                    echo "Amplify config does not exist"
                    exit 1
                  fi

            - name: 🧰 Setup Expo and EAS
              uses: expo/expo-github-action@v8
              with:
                  token: ${{ secrets.EXPO_TOKEN }}
                  expo-version: latest
                  eas-version: latest

            - name: 👷 Build iOS app
              run: |
                  eas build --local \
                    --non-interactive \
                    --output=./app-build \
                    --platform=ios \
                    --profile=${{ github.ref_name}}

            - name: Notify Discord
              uses: sarisia/actions-status-discord@v1
              if: failure() || success()
              with:
                  webhook: ${{ secrets.DISCORD_WEBHOOK_DEPLOYMENT_DEV }}
                  title: "iOS Build"
                  description: ${{ job.status == 'success' && 'iOS build has been completed' || 'iOS build has failed'}}
                  status: ${{ job.status }}
                  color: ${{ job.status == 'success' && '00FF00' || 'FF0000' }}

            - name: 📱 Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: app-ios
                  path: app-build

            - name: 🚢 Submit iOS app
              run: |
                  eas submit -p ios --profile  ${{ github.ref_name }} --path app-build --non-interactive

            - name: Notify Discord
              uses: sarisia/actions-status-discord@v1
              if: failure() || success()
              with:
                  webhook: ${{ secrets.DISCORD_WEBHOOK_DEPLOYMENT_DEV }}
                  title: "iOS Shipment"
                  description: "iOS shipment has been completed"
                  status: ${{ job.status }}
                  color: ${{ job.status == 'success' && '00FF00' || 'FF0000' }}

    build-android:
        runs-on: ubuntu-latest
        environment: ${{ github.ref_name}}

        steps:
            - name: 📂 Checkout code
              uses: actions/checkout@v4

            - name: 🚀 Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: latest

            - name: Install pnpm
              run: npm install -g pnpm --unsafe-perm=true

            - name: 📦 Install dependencies
              run: pnpm install

            - name: PNPM Prepare .env file
              run: |
                  FLAVOR=${{ github.ref_name }} pnpm prepare-env

            - name: 📜 Create Amplify config
              run: |
                  echo ${{secrets.AMPLIFY_CONFIG}} | base64 --decode > src/configs/amplify/amplify-${{github.ref_name}}.json

            - name: 🔍 Check if Amplify config exists
              run: |
                  if [ ! -f src/configs/amplify/amplify-${{github.ref_name}}.json ]; then
                    echo "Amplify config does not exist"
                    exit 1
                  fi

            - name: 🧰 Setup Expo and EAS
              uses: expo/expo-github-action@v8
              with:
                  token: ${{ secrets.EXPO_TOKEN }}
                  expo-version: latest
                  eas-version: latest

            - name: 📜 Create Amplify config
              run: |
                  echo ${{secrets.AMPLIFY_CONFIG}} | base64 --decode > src/configs/amplify/amplify-${{github.ref_name}}.json

            - name: 👷 Build Android app
              run: |
                  eas build --local \
                    --output=./app-build \
                    --non-interactive \
                    --platform=android \
                    --profile=${{ github.ref_name}}

            - name: Notify Discord
              uses: sarisia/actions-status-discord@v1
              if: failure() || success()
              with:
                  webhook: ${{ secrets.DISCORD_WEBHOOK_DEPLOYMENT_DEV }}
                  title: "Android Build"
                  description: ${{ job.status == 'success' && 'Android build has been completed' || 'Android build has failed'}}
                  status: ${{ job.status }}
                  color: ${{ job.status == 'success' && '00FF00' || 'FF0000' }}

            - name: 📱 Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: app-android
                  path: app-build
                  retention-days: 1
                  overwrite: true

            - name: 🚢 Submit Android app
              run: eas submit -p android --profile ${{ github.ref_name }} --path app-build

            - name: Notify Discord
              uses: sarisia/actions-status-discord@v1
              if: failure() || success()
              with:
                  webhook: ${{ secrets.DISCORD_WEBHOOK_DEPLOYMENT_DEV }}
                  title: "Android Shipment"
                  description: "Android shipment has been completed"
                  status: ${{ job.status }}
                  color: ${{ job.status == 'success' && '00FF00' || 'FF0000' }}
