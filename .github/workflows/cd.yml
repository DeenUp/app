name: Continuous Deployment

on:
    pull_request:
        types: [closed]
        branches:
            - production
            - dev
    push:
        branches:
            - staging

jobs:
    build-ios:
        runs-on: macOS-latest
        environment: ${{ github.ref_name}}

        steps:
            - name: ðŸ“‚ Checkout code
              uses: actions/checkout@v2

            - name: ðŸš€ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: latest

            - name: Install pnpm
              run: npm install -g pnpm --unsafe-perm=true

            - name: ðŸ“¦ Install dependencies
              run: pnpm install

            - name: ðŸ§° Setup Expo and EAS
              uses: expo/expo-github-action@v7
              with:
                  token: ${{ secrets.EXPO_TOKEN }}
                  expo-version: latest
                  eas-version: latest

            - name: ðŸ‘· Build iOS app
              env:
                  AMPLIFY_CONFIG: ${{ secrets.AMPLIFY_CONFIG }}
              run: |
                  eas build --local \
                    --non-interactive \
                    --output=./app-build \
                    --platform=ios \
                    --profile=${{ github.ref_name}}

            - name: ðŸš¢ Submit iOS app
              run: eas submit -p ios --profile ${{ github.ref_name }} --path app-build

    build-android:
        runs-on: ubuntu-latest
        environment: ${{ github.ref_name}}

        steps:
            - name: ðŸ“‚ Checkout code
              uses: actions/checkout@v2

            - name: ðŸš€ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: latest

            - name: Install pnpm
              run: npm install -g pnpm --unsafe-perm=true

            - name: ðŸ“¦ Install dependencies
              run: pnpm install

            - name: ðŸ§° Setup Expo and EAS
              uses: expo/expo-github-action@v7
              with:
                  token: ${{ secrets.EXPO_TOKEN }}
                  expo-version: latest
                  eas-version: latest

            - name: ðŸ‘· Build Android app
              env:
                  AMPLIFY_CONFIG: ${{ secrets.AMPLIFY_CONFIG }}
              run: |
                  eas build --local \
                    --output=./app-build \
                    --platform=android \
                    --profile=${{ github.ref_name}}

            - name: ðŸš¢ Submit Android app
              run: eas submit -p android --profile ${{ github.ref_name }} --path app-build
